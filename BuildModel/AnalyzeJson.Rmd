---
title: "Model performance"
author: "Ben Weinstein"
date: "January 13, 2017"
output: html_document
---

```{r,warning=F,message=F}
library(ggplot2)
library(dplyr)
library(reshape2)
library(stringr)
library(jsonlite)
library(yaml)
library(knitr)
opts_chunk$set(warning=F,message=F,echo=F)
```

#Access CloudBucket

```{r}
Sys.setenv("GCS_AUTH_FILE" = "C:/Users/Ben/Dropbox/Google/MeerkatReader-9fbf10d1e30c.json")
library(googleCloudStorageR)
#it should authenticate but its not doing it.
gcs_auth()
gcs_global_bucket("api-project-773889352370-ml")
#list objects
objects <- gcs_list_objects()

#find the objects we want
todl<-which(str_detect(objects$name,"prediction.results"))

for(x in todl){
gcs_get_object(objects$name[x], saveToDisk = objects$name[x])
}
#get file list.
filnames<-list.files("Prediction/",full.names = T)
```

```{r}
ndjson<-lapply(filnames,function(x){stream_in(file(x))})
#strip out scores.
ndj<-lapply(ndjson,function(x){
  x %>% select(key,prediction_label=prediction)
})
mdat<-bind_rows(ndj)

#extract key
mdat$key<-str_match(mdat$key,"/(\\d+_\\d+).jpg")[,2]
```

```{r}
#Training Data
tdata<-read.csv("C:/Users/Ben/Dropbox/MeerkatReader/Output/TrainingData.csv",header=F)
colnames(tdata)<-c("original","key","True_Class_original")

dict<-read.csv("cloudML/dict.txt",header=F)
colnames(dict)<-"Class"
dict$label<-seq(0,nrow(dict)-1,1)

#for now replace to strings, make new classes
tdata$TrueClass<-tdata$True_Class_original
levels(tdata$TrueClass)[levels(tdata$TrueClass)=="/"]<-"Forward_slash"
levels(tdata$TrueClass)[levels(tdata$TrueClass) %in% c(0,1,2,3,4,5,6,7,8,9)]<-c("Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine")

#merge labels and classes
tdata<-merge(tdata,dict,by.x="TrueClass",by.y="Class")

#trim out the full path
tdata$key<-str_match(tdata$key,"/MeerkatReader/\\w+/(\\w+).jpg")[,2]
```

#Tesseract Data

```{r cars}
tesdat<-read_json("tesseract.json")
tesdat<-melt(tesdat)
colnames(tesdat)<-c("Tesseract_Prediction","key")
```

#Combine for known sequences
```{r}
#merge cloudml data
kn<-merge(mdat,tdata,by=c("key"))

#merge tesseract data
kall<-merge(kn,tesdat,by="key")

#reorder
kall<-kall %>% select(key,label,prediction_label,Tesseract_Prediction)
```

#Accuarcy

## CloudML

```{r}
ggplot(kall,aes(x=label,y=prediction_label)) + geom_point()
conf_matrix<-as.matrix(table(kn$label,kn$prediction_label,deparse.level = 2))
conf_matrix<-conf_matrix/apply(conf_matrix,1,sum)

mc<-melt(conf_matrix)
colnames(mc)<-c("True","Predict","value")

#remove 0's
mc<-mc %>% filter(!value==0)

#get true classes
mc1<-merge(mc,dict,by.x="True",by.y="label")
colnames(mc1)[4]<-c("True_Class")

#Prediction classes
mc2<-merge(mc1,dict,by.x="Predict",by.y="label")
colnames(mc2)[5]<-c("Predict_Class")
```

##Confusion matrix - Trained Model

```{r,fig.height=4,fig.width=7}

#replot numberic labels
levels(mc2$Predict_Class)[levels(mc2$Predict_Class) %in% "Forward_slash"]<-"\\/"
levels(mc2$Predict_Class)[levels(mc2$Predict_Class) %in% "Zero"]<- 0
levels(mc2$Predict_Class)[levels(mc2$Predict_Class) %in% "One"]<- 1
levels(mc2$Predict_Class)[levels(mc2$Predict_Class) %in% "Two"]<- 2
levels(mc2$Predict_Class)[levels(mc2$Predict_Class) %in% "Three"]<- 3
levels(mc2$Predict_Class)[levels(mc2$Predict_Class) %in% "Four"]<- 4
levels(mc2$Predict_Class)[levels(mc2$Predict_Class) %in% "Five"]<- 5
levels(mc2$Predict_Class)[levels(mc2$Predict_Class) %in% "Six"]<- 6
levels(mc2$Predict_Class)[levels(mc2$Predict_Class) %in% "Seven"]<- 7
levels(mc2$Predict_Class)[levels(mc2$Predict_Class) %in% "Eight"]<- 8
levels(mc2$Predict_Class)[levels(mc2$Predict_Class) %in% "Nine"]<- 9

levels(mc2$True_Class)[levels(mc2$True_Class) %in% "Forward_slash"]<-"//"
levels(mc2$True_Class)[levels(mc2$True_Class) %in% "Zero"]<- 0
levels(mc2$True_Class)[levels(mc2$True_Class) %in% "One"]<- 1
levels(mc2$True_Class)[levels(mc2$True_Class) %in% "Two"]<- 2
levels(mc2$True_Class)[levels(mc2$True_Class) %in% "Three"]<- 3
levels(mc2$True_Class)[levels(mc2$True_Class) %in% "Four"]<- 4
levels(mc2$True_Class)[levels(mc2$True_Class) %in% "Five"]<- 5
levels(mc2$True_Class)[levels(mc2$True_Class) %in% "Six"]<- 6
levels(mc2$True_Class)[levels(mc2$True_Class) %in% "Seven"]<- 7
levels(mc2$True_Class)[levels(mc2$True_Class) %in% "Eight"]<- 8
levels(mc2$True_Class)[levels(mc2$True_Class) %in% "Nine"]<- 9

#resort levels
mc2$True_Class<-factor(mc2$True_Class,levels=sort(levels(mc2$True_Class)))
mc2$Predict_Class<-factor(mc2$Predict_Class,levels=sort(levels(mc2$Predict_Class)))

ggplot(mc2,aes(x=True_Class,y=Predict_Class,fill=value)) + geom_tile() + theme_bw() + scale_fill_continuous(low="blue",high="red",labels=scales::percent) + labs(x="True",y="Predicted",fill="Accuracy")
ggsave("Figures/ConfusionMatrix_cloudml.jpg",height=4,width=6)
```
